% ============================================================================
% !Document: DB02 [zxweather Database Structure]
% ----------------------------------------------------------------------------
% !Revision: 001
% !IssueDate: January 2013
% !Status: Unreleased
%
% !-Classification
% !ProjectCode: DAZW [zxweather]
% !Type: DB [Database Structure]
%
% !Copyright: (C) David Goodwin, 2012, 2013
% !License: FDL [GNU Free Documentation License]
% !Auhtor: David Goodwin
% ============================================================================

% Document information. This should match the above
\newcommand{\doctitle}{zxweather}
\newcommand{\docsubtitle}{Database Structure}
%\newcommand{\projectnum}{DAZW}
\newcommand{\docnum}{DB02}
\newcommand{\docrev}{001}
\newcommand{\docdate}{January 2013}
\newcommand{\docauthor}{David Goodwin}
\newcommand{\docabstract}{This document provides an overview of the database structure used by zxweather.}
\newcommand{\docupdateinfo}{This is a new manual.}
\newcommand{\docosver}{Any}
\newcommand{\docswver}{zxweather 0.2}
\newcommand{\doccopyright}{\textcircled{c} Copyright David Goodwin, 2012, 2013.}
\newcommand{\doclicense}{Use, reproduction and modification of this document is permitted subject to the terms of the GNU Free Documentation License, Version 1.3 or any later vesion published by the Free Software Foundation. See \url{http://www.gnu.org/copyleft/fdl.html} for full license text.}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                 CONFIGURATION                             %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Article type document, A4 paper, 10pt std font size:
\documentclass[a4paper,10pt]{book} 

\usepackage[scaled=0.90]{helvet} % Use helvetica as the standard font
\usepackage{courier}			 % Use courier as the fixed-width font
\usepackage{hyperref}			 % Links in PDF output
\usepackage{a4wide}				 % Narrower margins for A4 documents
\usepackage{ifthen}				 % A few if statements
\usepackage{multirow}			 % Column spanning in tables
\usepackage{listings}			 % For SQL code listings

% use zxtechdoc styles if they're there
\IfFileExists{zxtitle.sty}{\usepackage{zxtitle}}{}
\IfFileExists{zxtechdoc.sty}{\usepackage{zxtechdoc}}{}

\hypersetup{
    unicode=false,          % non-Latin characters in Acrobat’s bookmarks
    pdftoolbar=true,        % show Acrobat’s toolbar?
    pdfmenubar=true,        % show Acrobat’s menu?
    pdffitwindow=false,     % window fit to page when opened
    pdfstartview={FitH},    % fits the width of the page to the window
    pdftitle={\doctitle{} - \docsubtitle},    % title
    pdfauthor={\docauthor},     % author
    pdfsubject={\doctitle},   % subject of the document
    pdfkeywords={\doctitle} {\docsubtitle}, % list of keywords
    pdfnewwindow=true,      % links in new window
    colorlinks=true,       % false: boxed links; true: colored links
    linkcolor=black,          % color of internal links
    citecolor=green,        % color of links to bibliography
    filecolor=magenta,      % color of file links
    urlcolor=black           % color of external links
}

% Build the partnumber. Format is PROJ-DOCU.REV. If revision is 001 then it 
% is not displayed. If project is undefined it is not displayed.
\newcommand{\partnumber}{\ifthenelse{\isundefined{\projectnum}}{}{\projectnum-\docnum	\ifthenelse{\equal{\docrev}{001}}{}{.\docrev}}}

\newcommand*\cleartoleftpage{%
  \clearpage
  \ifodd\value{page}\hbox{}\newpage\fi
}

\begin{document}

% Roman Numerals for the front matter
\pagenumbering{roman}

% Setup the titlepage. We will use the zxtitle format if its there,
% otherwise the much simpler standard LaTeX one.
\ifthenelse{\isundefined{\ordernumber}}{

% Standard LaTeX titlepage
\title{\doctitle{} - \docsubtitle}
\author{\docauthor}
}{

% zxtitle titlepage
\title{\doctitle}
\subtitle{\docsubtitle}
\titleabstract{\docabstract}
\ordernumber{\partnumber}
\updateinfo{\docupdateinfo}
\osinfo{\docosver}
\swversion{\docswver}
\titlecopyright{\doccopyright}
\licensestatement{\doclicense}
}
\date{\docdate}

\maketitle

\clearpage

\tableofcontents
\clearpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                 DOCUMENT                                  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Introduction}
% Back to arabac numerals for the proper content
\pagenumbering{arabic}
\setcounter{page}{1}

zxweather uses a PostgreSQL database to store weather data and for some communication between components. No other RDMBS is supported in any way.

This manual describes the schema used by zxweather version 0.2. It is divided up into five chapters which define the various parts of the database:
\begin{itemize}
\item Chapter \ref{cha_tables}: Tables
\item Chapter \ref{cha_views}: Views
\item Chapter \ref{cha_functions}: Functions and Trigger Functions
\item Chapter \ref{cha_domains}: Domains
\item Chapter \ref{cha_notify}: Notification Channels
\end{itemize}

For documentation on the database schema used by zxweather version 0.1, see document \verb|DAZW-DB01|.

\section{Changes from v0.1}
zxweather version 0.2 introduced significant database changes to allow multiple different weather stations of different hardware types to all log to the same database. This resulted in a number of new tables and changes to all existing tables and views. It also introduces schema versioning minimum application versions to be specified allowing applications to determine if they are compatible with the database or not.

\subsection{New Tables}
These tables are new in the v0.2 schema:
\begin{itemize}
\item \verb|db_info| (section \ref{tbl_db_info})
\item \verb|station| (section \ref{tbl_station})
\item \verb|station_type| (section \ref{tbl_station_type})
\item \verb|wh1080_sample| (section \ref{tbl_wh1080_sample})
\end{itemize}

\subsection{Changes to Views}
All views now have a \verb|station_id| column which indicates which station the particular row belongs to. The \verb|latest_record_number| view now includes multiple rows - one for each station.

\subsection{New functions}
These functions are new in the v0.2 schema:
\begin{itemize}
\item \verb|minimum_version_string(character varying)| (section \ref{func_minimum_version_string})
\item \verb|version_check(varchar, integer, integer, integer)| (section \ref{func_version_check})
\item \verb|wind_direction_to_degrees(character varying)| (section \ref{func_wind_direction_to_degrees})
\end{itemize}

\subsection{New trigger functions}
These trigger functions are new in the v0.2 schema:
\begin{itemize}
\item \verb|compute_wh1080_sample| (section \ref{compute_wh1080_sample_values})
\end{itemize}

\subsection{Changes to Notification Channels}
Notifications about data updates are now sent with a payload containing a station code. This station code is the code for the station that caused the notification to be generated.

\section{Related Documents}
The following documents describe the rest of zxweather.

\begin{tabular}{l l}
\verb|DAZW-IG01| & zxweather Installation Reference, version 0.1 \\
\verb|DAZW-UR02| & zxweather Upgrade Installation Guide, version 0.2\\
\verb|DAZW-WG01| & zxweather WH1080 Utilities Users Guide, version 0.1 \\
\end{tabular}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Tables}
\label{cha_tables}

This chapter documents the database tables used by zxweather.

%%%%%%%%%%%%%%%%%%%%%%
\section{station\_type}
\label{tbl_station_type}
This table stores information about different station hardware types. It typically contains only two rows:
\begin{enumerate}
\item \emph{FOWH1080} - Fine Offset WH1080-compatible hardware. Any samples logged against a station of this type must have an associated record in the \verb|wh1080_sample| table.
\item \emph{GENERIC} - Generic hardware. It is assumed that there are no hardware-specific tables that need to be replicated by the db\_push tool.
\end{enumerate}

\subsection{Applications}
The following applications use this table:
\begin{itemize}
\item db\_push
\item wh1080 update tools
\end{itemize}

\subsection{Columns}

\subsubsection{station\_type\_id}
The primary key.

\subsubsection{code}
An 8-character code used to uniquely identify the station type.

\subsubsection{title}
A descriptive name for the station type.
 
 
%%%%%%%%%%%%%%%%%%%%%%
\section{station}
\label{tbl_station}
This table contains information about a specific weather station in the database. This includes some configuration data such as its sample interval and if live data is available for it.

\subsection{Applications}
The following applications use this table:
\begin{itemize}
\item Web Interface
\item Desktop Client
\item db\_push
\item wh1080 update tools
\end{itemize}
 
\subsection{Columns}

\subsubsection{station\_id}
The primary key.

\subsubsection{code}
A five character unique identifier for the station. This is used as a payload for station-specific notification messages in the database. It also forms part of the URL for the station in the zxweather web interface.

Its value should never be changed once set as doing so will break any existing links to pages within the zxweather web interface.

\subsubsection{title}
A name for the weather station that can be displayed to users.

\subsubsection{description}
A full description for the weather station that can be displayed to users.

\subsubsection{station\_type\_id}
The type of hardware that this weather station runs on.

This is a foreign key to the \verb|station_type| table.

\subsubsection{sample\_interval}
How often new samples are logged to the database (in seconds).

This is used in the web interface for calculating maximum cache ages and for finding gaps in the data.

\subsubsection{live\_data\_available}
If this weather station makes live data available in the \verb|live_data| table. If this is set to true then there must be a record in that table for this station. That record should be updated when ever new data is available.

If it is set to false then clients should use the most recent sample record for the station as a substitute for live data.

%%%%%%%%%%%%%%%%%%%%%%
\section{sample}
This is core weather history table. It contains only weather data with any hardware-specific data living in other tables. Some columns are computed automatically by a trigger on insert.

\subsection{Applications}
The following applications use this table:
\begin{itemize}
\item data collection tools (such as wh1080d)
\item web interface
\item db\_push
\item Desktop Client
\end{itemize}

\subsection{Columns}
\subsubsection{sample\_id}
This is the primary key.

\subsubsection{download\_timestamp}
When the record was downloaded from the weather station. It is not used directly for anything.

\subsubsection{time\_stamp}
The time this sample was taken by the weather station. 

\subsubsection{indoor\_relative\_humidity}
The relative humidity at the base station. Its type is the \verb|rh_percentage| domain type (see section \ref{rh_percentage}). Values are 0-99\%.

\subsubsection{indoor\_temperature}
The temperature at the base station in degrees Celsius. 

\subsubsection{relative\_humidity}
The relative humidity at the outdoor unit. Its type is the \verb|rh_percentage| domain type (see section \ref{rh_percentage}). Values are 0-99\%.

\subsubsection{temperature}
The temperature at the outdoor unit in degrees Celsius.

\subsubsection{dew\_point}
Dew point. This columns value is calculated on insert by a trigger using the dew\_point function (Section \ref{dew_point}). It is calculated from the \verb|temperature| and \verb|relative_humidity| columns.

\subsubsection{wind\_chill}
Wind chill. This columns value is calculated on insert by a trigger using the wind\_chill function (Section \ref{wind_chill}). It is calculated from the \verb|temperature| and \verb|average_wind_speed| columns.

\subsubsection{apparent\_temperature}
Apparent temperature. This columns value is calculated on insert from the following columns by a trigger using the \verb|apparent_temperature| function (section \ref{apparent_temperature}):
\begin{itemize}
\item \verb|temperature|
\item \verb|relative_humidity|
\item \verb|average_wind_speed|
\end{itemize}

\subsubsection{absolute\_pressure}
The absolute pressure in hectopascals (hPa, same as the millibar).

\subsubsection{average\_wind\_speed}
Average wind speed in metres per second.

\subsubsection{gust\_wind\_speed}
Gust wind speed in metres per second.

\subsubsection{wind\_direction}
Wind direction in degrees. Zero is North.

\subsubsection{rainfall}
The rainfall for this record in millimetres.

WH1080-compatible hardware does not directly provide rainfall values in its samples. It is calculated as the difference from the \verb|total_rain| from the previous sample. If the \verb|rain_overflow| column is set then the actual value is used instead. Values are multiples of 0.3mm.

\subsubsection{station\_id}
This is the ID of the station the sample came from. It is a foreign key to the \verb|station| table.

\subsection{Indices}
This table has the following indices:
\begin{itemize}
\item \verb|idx_time_stamp| on \verb|time_stamp| column.
\end{itemize}

\subsection{Triggers}
The \verb|compute_sample_values| trigger function is executed for each row inserted. This trigger calculates values for columns such as \verb|dew_point|. See section \ref{compute_sample_values} for more details on this trigger function.

\subsection{WH1080 Implementation Notes}
All data specific to WH1080-compatible hardware is stored in the \verb|wh1080_sample| table. Each sample that comes from WH1080-compatible hardware should have a matching record in that table to enable values such as rainfall to be calculated.

\subsubsection{time\_stamp column}
For WH1080 hardware, the \verb|time_stamp| column is calculated from the computers clock by the wh1080 update tool. As such the time stamp is only approximate and may be out by a minute or two.

If the \verb|last_in_batch| column in the \verb|wh1080_sample| table is \verb|true| then the timestamp value in the associated \verb|sample| record was determined by waiting for the live data record on the weather station to change. The live data records \verb|sample_time| field is then used to compute the timestamp for this record.

If the \verb|last_in_batch| column is \verb|false| then the records timestamp value was calculated based on the its \verb|record_number|, the \verb|sample_interval| of the previous record and the \verb|time_stamp| of the previous record.


\section{wh1080\_sample}
\label{tbl_wh1080_sample}
This table contains data specific to WH1080-compatible hardware. Each row in this table is associated with a row in the \verb|sample| table. It is not used by the web interface or desktop client but its contents is replicated by the db\_push tool.

\subsection{Applications}
The following applications use this table
\begin{itemize}
\item wh1080 update tools
\item db\_push
\end{itemize}

\subsection{Columns}
\subsubsection{sample\_id}
The primary key.

This column is a foreign key to the \verb|sample| table.

\subsubsection{sample\_interval}
This is the number of minutes since the previous sample on the weather station. It is used for calculating timestamps. It is not used directly for anything else.

\subsubsection{record\_number}
The history slot on the weather station this record was downloaded from. Its range is 0-4079. It is only used to track which records have already been downloaded from the weather station when performing updates and for calculating timestamps.

\subsubsection{last\_in\_batch}
If this record was the final record in a batch of records downloaded from the weather station. This records timestamp is the one used to calculate all other records downloaded in the batch.

\subsubsection{invalid\_data}
If the record on the weather station had the invalid data status flag set. The WH1080 documentation refers to this as both "rain counter value is not valid" and "no sensor data received"

\subsubsection{wind\_direction}
Wind direction. Its type is the \verb|wind_direction| domain type. See section \ref{wind_direction} for valid values.

\subsubsection{total\_rain}
Total rainfall since it last overflowed. This is used only for calculating the values in the sample tables \verb|rainfall| column. Values are a multiple of 0.3. Unit is the millimetre. 

\subsubsection{rain\_overflow}
If an overflow in the \verb|total_rain| counter has occurred. Used for calculating values in the sample tables \verb|rainfall| column.

\subsection{Triggers}
The \verb|compute_wh1080_sample_values| trigger function is executed for each row inserted. This trigger calculates a number of values in the associated sample record. See section \ref{compute_wh1080_sample_values} for more details on this trigger function.

\section{live\_data}
This table stores live data from all weather stations. It only ever contains one record for each weather station. It is updated by data collection tools such as the \verb|wh1080d| program when ever there is new live data. Its set of fields is a subset of those in the sample table.

This table does not provide access to live rainfall data. Calculating this for WH1080 hardware would be difficult as it requires access to the previous samples rainfall. The wh1080d application updates live data before downloading and inserting any new history records so the previous samples rainfall data is not available from the live\_data update trigger or within the wh1080d application.

\subsection{Applications}
The following applications use this table:
\begin{itemize}
\item wh1080d (database update daemon)
\item web interface
\item desktop client
\item db\_push
\end{itemize}

\subsection{Columns}
All columns except wind direction and invalid data allow nulls.

\subsubsection{station\_id}
The station this live data record is for. This column doubles as the tables primary key restricting the table to one record for each station.

\subsubsection{download\_timestamp}
When this data was downloaded from the weather station.

\subsubsection{indoor\_relative\_humidity}
The relative humidity at the base station. Values are 0-99\%. 

\subsubsection{indoor\_temperature}
The temperature at the base station in degrees Celsius. 

\subsubsection{relative\_humidity}
The relative humidity at the outdoor unit. Values are 0-99\%.

\subsubsection{temperature}
The temperature at the outdoor unit in degrees Celsius.

\subsubsection{dew\_point}
Dew point. This columns value is calculated on update by a trigger using the dew\_point function (Section \ref{dew_point}). It is calculated from the \verb|temperature| and \verb|relative_humidity| columns.

\subsubsection{wind\_chill}
Wind chill. This columns value is calculated on update by a trigger using the wind\_chill function (Section \ref{wind_chill}). It is calculated from the \verb|temperature| and \verb|average_wind_speed| columns.

\subsubsection{apparent\_temperature}
Apparent temperature. This columns value is calculated on update from the following functions by a trigger using the \verb|apparent_temperature| function (Section \ref{apparent_temperature}):
\begin{itemize}
\item \verb|temperature|
\item \verb|relative_humidity|
\item \verb|average_wind_speed|
\end{itemize}

\subsubsection{absolute\_pressure}
The absolute pressure in hectopascals (hPa, same as the millibar).

\subsubsection{relative\_pressure}
Calculated relative pressure in hectopascals (hPa, same as the millibar).

This column is for future use. Its value is not currently calculated.

\subsubsection{average\_wind\_speed}
Average wind speed in metres per second.

\subsubsection{gust\_wind\_speed}
Gust wind speed in metres per second.

\subsubsection{wind\_direction}
Wind direction in degrees. Zero is North.

\section{db\_info}
\label{tbl_db_info}
This table stores basic information about the database in a key/value format. It was introduced in the v0.2 schema to allow identification of the database version.

\subsection{Columns}
\subsubsection{k}
This is a 10-character unique key.

\subsubsection{v}
Data. Field type is character varying (no limit)

\subsection{Defined values}
The following keys are defined in zxweather v0.2.

\begin{tabular}{l l}
\hline
\textbf{Key} & \textbf{Description} \\
\hline
\verb|DB_VERSION| & The database version. The schema described by this manual is version 2. \\
\verb|MIN_VER_MAJ| & The minimum zxweather major version number.\\
\verb|MIN_VER_MIN| & The minimum zxweather minor version number.\\
\verb|MIN_VER_REV| & The minimum zxweather revision number.\\
\verb|*_MIN_VER_MAJ| & Application-specific minimum major version number.\\
\verb|*_MIN_VER_MIN| & Application-specific minimum minor version number.\\
\verb|*_MIN_VER_REV| & Application-specific minimum revision version number.\\
\hline
\end{tabular}

All of these keys are used by applications to determine if they are compatible with a particular zxweather database. See chapter \ref{cha_version} for more details on how this works.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Views}
\label{cha_views}

\section{latest\_record\_number}
This view is used by the wh1080 database update utilities to determine what the most recent record in the database is.

\section{Daily, Montly and Yearly Records}
These views provide minimum and maximum weather conditions (temperature, humidity, etc) for each day, month or year in the database. The views are:
\begin{itemize}
\item daily\_records
\item monthly\_records
\item yearly\_records
\end{itemize}

The PostgreSQL query planner seems to have difficulty with the queries behind these views when more than one column is included in a where clause. This has been observed in PostgreSQL version 9.1.

\subsection{Columns}
\begin{itemize}
\item \verb|date_stamp|: The date the record is for (daily\_records and monthly\_records only).
\item \verb|year_stamp|: The year the record is for. Present only in the yearly\_records view.
\item \verb|station_id|: The station this data is for.
\item \verb|total_rainfall|: Total rainfall during this day, month or year.
\item \verb|max_gust_wind_speed|: Maximum gust wind speed for the period.
\item \verb|max_gust_wind_speed_ts|: Most recent timestamp for the maximum gust wind speed record.
\item \verb|max_average_wind_speed|: Maximum average wind speed for the period.
\item \verb|max_average_wind_speed_ts|: Most recent timestamp for the maximum wind speed record.
\item \verb|min_absolute_pressure|: Minimum absolute pressure during the period.
\item \verb|min_absolute_pressure_ts|: Most recent timestamp for the minimum absolute pressure \\ record.
\item \verb|max_absolute_pressure|: Maximum absolute pressure during the period.
\item \verb|max_absolute_pressure_ts|: Most recent timestamp for the maximum absolute pressure record.
\item \verb|min_apparent_temperature|: Minimum apparent temperature during the period.
\item \verb|min_apparent_temperature_ts|: Most recent timestamp for the minimum apparent temperature record.
\item \verb|max_apparent_temperature|: Maximum apparent temperature during the period.
\item \verb|max_apparent_temperature_ts|: Most recent timestamp for the maximum apparent temperature record.
\item \verb|min_wind_chill|: Minimum wind chill during the period.
\item \verb|min_wind_chill_ts|: Most recent timestamp for the minimum wind chill record.
\item \verb|max_wind_chill|: Maximum wind chill during the period.
\item \verb|max_wind_chill_ts|: Most recent timestamp for the maximum wind chill record.
\item \verb|min_dew_point|: Minimum dewpoint during the period.
\item \verb|min_dew_point_ts|: Most recent timestamp for the minimum dewpoint record.
\item \verb|max_dew_point|: Maximum dewpoint during the period.
\item \verb|max_dew_point_ts|: Most recent timestamp for the maximum dewpoint record.
\item \verb|min_temperature|: Minimum outdoor temperature during the period.
\item \verb|min_temperature_ts|: Most recent timestamp for the minimum outdoor temperature record.
\item \verb|max_temperature|: Maximum outdoor temperature during the period.
\item \verb|max_temperature_ts|: Most recent timestamp for the maximum outdoor temperature record.
\item \verb|min_humidity|: Minimum outdoor relative humidity during the period.
\item \verb|min_humidity_ts|: Most recent timestamp for the minimum outdoor relative humidity record.
\item \verb|max_humidity|: Maximum outdoor relative humidity during the period.
\item \verb|max_humidity_t|: Most recent timestamp for the maximum outdoor relative humidity record.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Functions and Trigger Functions}
\label{cha_functions}

The database contains a number of stored procedures for computing values that don't come directly from the weather station. This chapter gives an overview of those functions.

\section{Functions}
\label{functions}

\subsection{apparent\_temperature}
\label{apparent_temperature}
Calculates the Apparent Temperature using the formula used by the Australian Bureau of Meteorology.

The formula used is:
$$AT = Ta + 0.33e - 0.7ws - 4.00$$
% AT = Ta + 0.33e − 0.70ws − 4.00

Where $Ta$ is the dry bulb temperature ($^{\circ}$C), $e$ is the water vapour pressure in hPa and ws is the Wind speed (m/s) at an elevation of 10 metres.

The vapour pressure is calculated from the temperature and relative humidity using the formula:

$$  e = rh / 100 * 6.105 * 2.718281828 ^ { 17.27Ta / (237.7 + Ta ) }$$
where $Ta$ is the dry bulb temperature ($^{\circ}$C), rh is the relative humidity (\%).

See the Australian Bureau of Meteorology website for more details: \\ \url{http://www.bom.gov.au/info/thermal_stress/}

This function is \emph{immutable}.

\subsubsection{Parameters}
\begin{itemize}
\item temperature, real
\item wind\_speed, real
\item relative\_humidity, real
\end{itemize}

\subsection{dew\_point}
\label{dew_point}

Calculates the approximate dew point given temperature and relative humidity. The calculation is based on the August-Roche-Magnus approximation for the saturation vapour pressure of water in air as a function of temperature. It is valid for input temperatures 0 to 60 $^{\circ}$C and dew points 0 to 50 $^{\circ}$C

The formula is:
$$T_d = \frac {b\ \gamma(T,RH)} {a - \gamma(T,RH)}$$
where
$$\gamma(T,RH) = \frac {a\ T} {b+T} + \ln (RH/100)$$

where the temperatures are in degrees Celsius. The constants are $a$ = 17.271 and $b$ = 237.7 $^{\circ}$C

See the article on Wikipedia for more details: \url{http://en.wikipedia.org/wiki/Dewpoint}

This function is \emph{immutable}.

\subsubsection{Parameters}
\begin{itemize}
\item temperature, real
\item relative\_humidity, integer
\end{itemize}

\subsection{minimum\_version\_string}
\label{func_minimum_version_string}

Returns the oldest version of the specified application that is compatible with this database. Its value is derived from the \verb|db_info| table (section \ref{tbl_db_info}). If the application does not have a minimum version number entry in there then the minimum zxweather version is returned instead.

See chapter \ref{cha_version} (Versioning) for more details on how database and application versioning works.

\subsubsection{Parameters}
\begin{itemize}
\item application, character varying
\end{itemize}

\subsection{version\_check}
\label{func_version_check}

This function checks if the specified application version is compatible with the database. This is done by looking up the application-specific minimum version in the \verb|db_info| table (section \ref{tbl_db_info}) and comparing it to the supplied version number. 

If the application does not have a minimum version number in the \verb|db_info| table then the minimum zxweather version is used instead.

See chapter \ref{cha_version} (Versioning) for more details on how database and application versioning works.

\subsubsection{Parameters}
\begin{itemize}
\item application, character varying
\item major, integer
\item minor, integer
\item revision, integer
\end{itemize}

\subsection{wind\_chill}
\label{wind_chill}
Calculates the North American wind chill using the following formula:
$$T_{wc}=13.12 + 0.6215 T_a-11.37 V^{+0.16} + 0.3965 T_a V^{+0.16}\,\!$$
where $T_{wc}$ is the wind chill index in degrees Celsius, $T_a$ is the air temperature in degrees Celsius and $V$ is the wind speed at 10 metres in kilometres per hour.

The Wind chill temperature is only defined for air temperatures below 10 $^{\circ}$C and wind speeds above 4.8 km/h.

See the article on Wikipedia for more details:
\url{http://en.wikipedia.org/wiki/Wind_chill}

This function is \emph{immutable}.

\subsubsection{Parameters}
\begin{itemize}
\item temperature, real
\item wind\_speed, real
\end{itemize}

\subsection{wind\_direction\_to\_degrees}
\label{func_wind_direction_to_degrees}
Converts the supplied wind direction string to a value in degrees. This is used primarily by WH1080-related code as that station records wind direction as a string.

\subsubsection{Conversion table}
\begin{tabular}{l l}
\hline
\textbf{Value} & \textbf{In degrees} \\
\hline
N & 0\\
NNE & 22.5\\
NE & 45\\
ENE & 67.5\\
E & 90\\
ESE & 112.5\\
SE & 135\\
SSE & 157.5\\
S & 180\\
SSW & 202.5\\
SW & 225\\
WSW & 247.5\\
W & 270\\
WNW & 292.5\\
NW & 315\\
NNW & 337.5\\
\hline
\end{tabular}

All other values are converted to \verb|null|.

\subsubsection{Parameters}
\begin{itemize}
\item wind\_direction character varying
\end{itemize}

\section{Trigger Functions}
\label{trig_funcs}
\subsection{compute\_sample\_values}
\label{compute_sample_values}
Computes values for the following fields when a new record is inserted:
\begin{itemize}
\item dew\_point (see dew\_point function, section \ref{dew_point})
\item wind\_chill (see wind\_chill function, section \ref{wind_chill})
\item apparent\_temperature (see apparent\_temperature function, section \ref{apparent_temperature})
\end{itemize}

\subsection{compute\_wh1080\_sample\_values}
\label{compute_wh1080_sample_values}

Calculates any values that need calculating for WH1080-compatible hardware. Its calculations are based off the data stored in the hardware-specific \verb|wh1080_sample| table. This is currently limited wind direction (calculated with \verb|wind_direction_to_degrees|, section \ref{func_wind_direction_to_degrees}) and rainfall which is discussed below.

\subsubsection{Rainfall calculation}
The rainfall value in the \verb|sample| table is calculated using the following query:

% Setup listings package
\lstset{
  language=SQL,
  frame=single,
  numbers=left,
  basicstyle=\small,
  commentstyle=\emph
}

\begin{lstlisting}
select into NEW.rainfall
       case when NEW.total_rain - prev.total_rain >= 0 then
           NEW.total_rain - prev.total_rain
       else
           NEW.total_rain + (19660.8 - prev.total_rain)
       end as rainfall
from sample prev
-- find the previous sample:
where time_stamp = (select max(time_stamp)
                    from sample ins
                    where ins.time_stamp < NEW.time_stamp)
\end{lstlisting}

The value $19660.8$ is the maximum rainfall accumulator value (65536 * 0.3mm). Rainfall values are calculated based on the total rainfall value of the new record and the previous record in the database.

\subsection{live\_data\_update}
Computes values for live\_data table updates.

It computes values for the following fields:
\begin{itemize}
\item dew\_point
\item wind\_chill
\item apparent\_temperature
\end{itemize}

It also generates a notification on channel live\_data\_updated,

It is only used on the live\_data table.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Domains}
\label{cha_domains}

Domains are used on a number of columns to simplify constraints, etc. This chapter gives an overview of those domains and their valid values.

\section{rh\_percentage}
\label{rh_percentage}
Used for columns containing relative humidity percentages. It is an \verb|integer| field.

This domain used to enforce a not null constraint and values between 0 and 99. This was removed in zxweather v0.1.2 to allow for invalid data logged by WH1080-type hardware. The check constraint is now directly on the sample table so that it is executed after trigger functions are executed to tidy up the data.

\section{wind\_direction}
\label{wind_direction}

Used for columns containing wind directions. Valid values are:
\begin{itemize}
\item N
\item NNE
\item NE
\item ENE
\item E
\item ESE
\item SE
\item SSE
\item S
\item SSW
\item SW
\item WSW
\item W
\item WNW
\item NW
\item NNW
\item INV (used for invalid values).
\end{itemize}

its type is \verb|character varying(3)|


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Notification Channels}
\label{cha_notify}

zxweather uses the PostgreSQL NOTIFY feature to notify components of the system that new data has arrived. This chapter covers the notification channels used by zxweather and their meaning.

\section{live\_data\_updated}
A notification is broadcast on this channel when data in the live\_data table has been updated. The notification is sent automatically from the live\_data\_update trigger function. The payload is the station code for the station that just received updated live data.

Clients interested in displaying live data should listen on this channel rather than polling the database.

\subsection{Applications}
The following applications use this channel:

\begin{itemize}
\item zxweather Desktop (GUI) Client
\end{itemize}

\section{new\_sample}
A notification is broadcast on this channel when a new sample has been inserted into the database. This notification is sent automatically from the compute\_sample\_values trigger function. The payload is the station code for the station that received the new sample

Clients interested in displaying history samples should listen on this channel rather than polling the database.

\subsection{Applications}
The following applications use this channel:

\begin{itemize}
\item zxweather Database Replicator
\end{itemize}

\section{update\_complete}
A notification with no payload is broadcast on this channel by the zxweather WH1080 Update Daemon when it has finished updating the live\_data table and inserting any new records into the sample table. The payload is the station code for the station that the WH1080 Update Daemon is running for.

This channel does not specify what has been updated. Listen on the live\_data\_updated and new\_sample channels as well to determine what has been updated.

If there are new history samples then the notification sequence will be:
\begin{itemize}
\item live\_data\_updated
\item new\_sample
\item update\_complete
\end{itemize}

If there are no new history samples then there will be no notification on the new\_sample channel.

\subsection{Applications}
The following applications use this channel:

\begin{itemize}
\item wh1080d (WH1080 Update Daemon) - issues notifications when it has finished doing work.
\item zxweather Database Replicator - waits for a notification on this channel before sending data to the remote database. A notification on the new\_sample channel instructs it to send new samples in addition to sending live data.
\end{itemize}

\chapter{Versioning}
\label{cha_version}
The database stores data to allow applications to determine if they are forwards or backwards compatible.

The data is:
\begin{itemize}
\item A schema version number for controlling backwards-compatibility
\item Minimum application versions for forwards-compatibility.
\end{itemize}

\section{Backwards compatibility}
When ever changes are made to the database schema its version number is incremented. This is stored in the \verb|db_info| table (section \ref{tbl_db_info}) as \verb|DB_VERSION|.

This allows applications to determine if a given database supports the features the application requires. 

As an example, all zxweather v0.2 applications require the database schema version number to be 2 or greater.

\section{Forwards compatibility}
Forwards compatibility is controlled through minimum application version numbers stored in the \verb|db_info| table. The minimum zxweather version number is broken up into its three components and stored under the following keys:
\begin{itemize}
\item \verb|MIN_VER_MAJ| - minimum major version
\item \verb|MIN_VER_MIN| - minimum minor version
\item \verb|MIN_VER_REV| - minimum revision number
\end{itemize}

Other applications may store their minimum version using the following scheme:
\begin{itemize}
\item \verb|APPNAME_MIN_VER_MAJ|
\item \verb|APPNAME_MIN_VER_MIN|
\item \verb|APPNAME_MIN_VER_REV|
\end{itemize}
where APPNAME is a short unique name for the application in uppercase. If these keys are not found in the table then the zxweather version numbers are used instead.

This all allows older versions of the various individual zxweather components to be blacklisted by future databases by increasing the minimum zxweather version number and introducing lower application-specific version numbers for those older components which are still compatible.

\subsection{Checking compatibility}
Minimum version numbers can be retrieved in string form using the \verb|minimum_version_string| function (section \ref{func_minimum_version_string}).

Application version compatibility checks can be performed by passing the application name and version components to the \verb|version_check| function (section \ref{func_version_check}). This function will return true if the passed in version number meets or exceeds the minimum version stored in the database.

\section{Handling v0.1.x databases}
Version 1 of the database schema (used by zxweather 0.1.x) did not carry the \verb|db_info| table. Checking for these old versions can be achieved by querying \verb|INFORMATION_SCHEMA.TABLES| for the presence of the \verb|db_info| table.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                END DOCUMENT                               %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Back page
\cleartoleftpage
\thispagestyle{empty}
\begin{flushright}
\null
\vfill
\tt \partnumber
\end{flushright}
\end{document}
