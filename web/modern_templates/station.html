{% extends "base.html" %}

{% block title %}Station  Overview{% endblock %}
{% block head %}
    <link rel="stylesheet" href="../css/modern.css" type="text/css"/>
{% endblock %}
{% block content %}
    <h1>Weather</h1>
    <hr>
    <h2>Current Conditions</h2>
    <div id="current_conditions">
    <table>
        <thead>
        <tr>
            <th>Sensor</th>
            <th>Value</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>Relative Humidity</td>
            <td id="live_relative_humidity"></td>
        </tr>
        <tr>
            <td>Temperature</td>
            <td id="live_temperature"></td>
        </tr>
        <tr>
            <td>Apparent Temperature</td>
            <td id="live_apparent_temperature"></td>
        </tr>
        <tr>
            <td>Wind Chill</td>
            <td id="live_wind_chill"></td>
        </tr>
        <tr>
            <td>Dew Point</td>
            <td id="live_dew_point"></td>
        </tr>
        <tr>
            <td>Absolute Pressure</td>
            <td id="live_absolute_pressure"></td>
        </tr>
        <tr>
            <td>Average Wind Speed</td>
            <td id="live_avg_wind_speed"></td>
        </tr>
        <tr>
            <td>Gust Wind Speed</td>
            <td id="live_gust_wind_speed"></td>
        </tr>
        <tr>
            <td>Wind Direction</td>
            <td id="live_wind_direction"></td>
        </tr>
        </tbody>
    </table>
    <p>Time: <span id="current_time"></span></p>
    </div>
    <div id="cc_stale" style="display: none;">
    <p class="warning">WARNING: Live data has not been refreshed in <span id="cc_data_age"></span> seconds. The
    update service has likely stopped.</p>
    </div>

    <h2>Records for Today</h2>
    <table>
        <thead>
        <tr>
            <th>Sensor</th>
            <th>Min</th>
            <th>Max</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td>Temperature</td>
            <td>{{ data.records.min_temperature|round(1) }}°C at {{ data.records.min_temperature_ts }}</td>
            <td>{{ data.records.max_temperature|round(1) }}°C at {{ data.records.max_temperature_ts }}</td>
        </tr>
        <tr>
            <td>Wind Chill</td>
            <td>{{ data.records.min_wind_chill|round(1) }}°C at {{ data.records.min_wind_chill_ts }}</td>
            <td>{{ data.records.max_wind_chill|round(1) }}°C at {{ data.records.max_wind_chill_ts }}</td>
        </tr>
        <tr>
            <td>Apparent Temperature</td>
            <td>{{ data.records.min_apparent_temperature|round(1) }}°C at {{ data.records.min_apparent_temperature_ts }}</td>
            <td>{{ data.records.max_apparent_temperature|round(1) }}°C at {{ data.records.max_apparent_temperature_ts }}</td>
        </tr>
        <tr>
            <td>Dew Point</td>
            <td>{{ data.records.min_dew_point|round(1) }}°C at {{ data.records.min_dew_point_ts }}</td>
            <td>{{ data.records.max_dew_point|round(1) }}°C at {{ data.records.max_dew_point_ts }}</td>
        </tr>
        <tr>
            <td>Absolute Pressure</td>
            <td>{{ data.records.min_absolute_pressure|round(1) }} hPa at {{ data.records.min_absolute_pressure_ts }}</td>
            <td>{{ data.records.max_absolute_pressure|round(1) }} hPa at {{ data.records.max_absolute_pressure_ts }}</td>
        </tr>
        <tr>
            <td>Relative Humidity</td>
            <td>{{ data.records.min_humidity }}% at {{ data.records.min_humidity_ts }}</td>
            <td>{{ data.records.max_humidity }}% at {{ data.records.max_humidity_ts }}</td>
        </tr>
        <tr>
            <td>Gust Wind Speed</td>
            <td class="no-value"></td>
            <td>{{ data.records.max_gust_wind_speed|round(1) }} m/s at {{ data.records.max_gust_wind_speed_ts }}</td>
        </tr>
        <tr>
            <td>Average Wind Speed</td>
            <td class="no-value"></td>
            <td>{{ data.records.max_average_wind_speed|round(1) }} m/s at {{ data.records.max_average_wind_speed_ts }}</td>
        </tr>
        </tbody>
    </table>
    <p>Total rainfall today: {{ data.records.total_rainfall|round(1) }}mm</p>

    <h2 id="today">Today</h2>
    <div id="daily-charts">
        <div class="left-column">
            <div id="chart_temperature_tdp_div"></div>
            <div id="chart_humidity_div"></div>
            {% if data.records.total_rainfall > 0 %}<div id="chart_hourly_rainfall_div"></div>{% endif %}
        </div>
        <div class="right-column">
            <div id="chart_temperature_awc_div"></div>
            <div id="chart_pressure_div"></div>
        </div>
        <div class="column-end"></div>
    </div>

    <h2>Last 7 days</h2>
    <div id="7day-charts">
        <div id="chart_7_temperature_tdp_div"></div>
        <div id="chart_7_temperature_awc_div"></div>
        <div id="chart_7_humidity_div"></div>
        <div id="chart_7_pressure_div"></div>
        {% if data.rainfall_7days_total > 0 %}<div id="chart_7_hourly_rainfall_div"></div>{% endif %}
    </div>

    <h2>Weather History</h2>
    <p>Weather data is available for the following years:
        {% set i = 0 %}
        {% for year in data.years %}
            {% set i = i + 1 %}
            <a href="{{ year }}/">{{ year }}</a> {% if i < data.years|length %}|{% endif %}
        {% endfor %}
    </p>
    <p>History page for: <a href="now">Today</a>,
                         {% if data.yesterday %}<a href="{{ data.yesterday.year }}/{{ data.yesterday_month_s }}/{{ data.yesterday.day }}/">Yesterday</a>,{% endif %}
                         <a href="{{ data.year }}/{{ data.month_s }}/">This Month</a>,
                         <a href="{{ data.year }}/">This Year</a>.
    </p>
    <hr>
    <p>Problems?
        <a href="../../b/{{ station }}/now">
            Basic HTML</a></p>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript">

        var previous_live = null;

        function refresh_live_data() {
            $.getJSON('../../data/{{ station }}/live.json', function(data) {

                // If the live data is over 5 minutes old show a warning instead.
                if (data['age'] > 300) {
                    $("#cc_data_age").html(data['age']);
                    $("#current_conditions").hide();
                    $("#cc_stale").show();
                } else {
                    $("#current_conditions").show();
                    $("#cc_stale").hide();

                    // Icons
                    var rh='', t='', at='', wc='', dp='', ap='', aws='', gws='';

                    var relative_humidity = data['relative_humidity'];
                    var temperature = data['temperature'].toFixed(1);
                    var apparent_temp = data['apparent_temperature'].toFixed(1);
                    var wind_chill = data['wind_chill'].toFixed(1);
                    var dew_point = data['dew_point'].toFixed(1);
                    var absolute_pressure = data['absolute_pressure'].toFixed(1);
                    var average_wind_speed = data['average_wind_speed'].toFixed(1);
                    var gust_wind_speed = data['gust_wind_speed'].toFixed(1);

                    if (previous_live != null) {
                        function get_ico(current, prev) {
                            if (current > prev)
                                return '<img src="../../images/up.png" alt="increase" title="increase"/>&nbsp;';
                            else if (current == prev)
                                return '<img src="../../images/no-change.png" alt="no change" title="no change"/>&nbsp;';
                            else
                                return '<img src="../../images/down.png" alt="decrease" title="decrease"/>&nbsp;';
                        }

                        rh = get_ico(relative_humidity, previous_live['relative_humidity']);
                        t = get_ico(temperature, previous_live['temperature'].toFixed(1));
                        at = get_ico(apparent_temp, previous_live['apparent_temperature'].toFixed(1));
                        wc = get_ico(wind_chill, previous_live['wind_chill'].toFixed(1));
                        dp = get_ico(dew_point, previous_live['dew_point'].toFixed(1));
                        ap = get_ico(absolute_pressure, previous_live['absolute_pressure'].toFixed(1));
                        aws = get_ico(average_wind_speed, previous_live['average_wind_speed'].toFixed(1));
                        gws = get_ico(gust_wind_speed, previous_live['gust_wind_speed'].toFixed(1));
                    }

                    $("#live_relative_humidity").html(rh + relative_humidity + '%');
                    $("#live_temperature").html(t + temperature + '°C');
                    $("#live_apparent_temperature").html(at + apparent_temp + '°C');
                    $("#live_wind_chill").html(wc + wind_chill + '°C');
                    $("#live_dew_point").html(dp + dew_point + '°C');
                    $("#live_absolute_pressure").html(ap + absolute_pressure + ' hPa');
                    $("#live_avg_wind_speed").html(aws + average_wind_speed + ' m/s');
                    $("#live_gust_wind_speed").html(gws + gust_wind_speed + ' m/s');
                    $("#live_wind_direction").html(data['wind_direction']);
                    $("#current_time").html(data['time_stamp']);

                }
                previous_live = data
            });
        }
        refresh_live_data();

        //google.load('visualization', '1', {packages:['table']});
        google.load("visualization", "1", {packages:["corechart"]});
        google.setOnLoadCallback(drawCharts);
        function drawCharts() {

            function drawAllCharts(data,
                                   tdp_element,
                                   awc_element,
                                   humidity_element,
                                   pressure_element) {

                // Temperature and Dewpoint only
                var temperature_tdp = new google.visualization.DataView(data);
                temperature_tdp.hideColumns([3,4,5,6]);

                var temperature_tdp_options = {
                    title: 'Temperature and Dew Point (°C)',
                    legend: {position: 'bottom'}
                };
                var temperature_tdp_chart = new google.visualization.LineChart(tdp_element);
                temperature_tdp_chart.draw(temperature_tdp, temperature_tdp_options);

                // Apparent Temperature and Wind Chill only
                var temperature_awc = new google.visualization.DataView(data);
                temperature_awc.hideColumns([1,2,5,6]);

                var temperature_awc_options = {
                    title: 'Apparent Temperature and Wind Chill (°C)',
                    legend: {position: 'bottom'}
                };
                var temperature_awc_chart = new google.visualization.LineChart(awc_element);
                temperature_awc_chart.draw(temperature_awc, temperature_awc_options);

                // Absolute Pressure only
                var pressure = new google.visualization.DataView(data);
                pressure.hideColumns([1,2,3,4,5]);

                var pressure_options = {
                    title: 'Absolute Pressure (hPa)',
                    legend: {position: 'none'},
                    vAxis: {format: '####'}
                };
                var pressure_chart = new google.visualization.LineChart(pressure_element);
                pressure_chart.draw(pressure, pressure_options);

                // Humidity only
                var humidity = new google.visualization.DataView(data);
                humidity.hideColumns([1,2,3,4,6]);

                var humidity_options = {
                    title: 'Humidity (%)',
                    legend: {position: 'none'}
                };
                var humidity_chart = new google.visualization.LineChart(humidity_element);
                humidity_chart.draw(humidity, humidity_options);
            }

            /***************************************************************
             * Fetch the days samples and draw the 1-day charts
             */
            $.getJSON('{{ urls.samples }}', function(data) {
                // This contains all samples for the day. Included columns are
                // 0: timestamp
                // 1: temperature
                // 2: dewpoint
                // 3: apparenttemp
                // 4: windchill
                // 5: humidity
                // 6: abspressure
                var sampledata = new google.visualization.DataTable(data);

                // Do some formatting
                var temperatureFormatter = new google.visualization.NumberFormat(
                        { pattern: '##.# °C'});
                temperatureFormatter.format(sampledata,1);
                temperatureFormatter.format(sampledata,2);
                temperatureFormatter.format(sampledata,3);
                temperatureFormatter.format(sampledata,4);

                var humidityFormatter = new google.visualization.NumberFormat(
                        { pattern: '##'});
                humidityFormatter.format(sampledata,5);

                var pressureFormatter = new google.visualization.NumberFormat(
                        { pattern: '####.# hPa'});
                pressureFormatter.format(sampledata,6);

                drawAllCharts(sampledata,
                              document.getElementById('chart_temperature_tdp_div'),
                              document.getElementById('chart_temperature_awc_div'),
                              document.getElementById('chart_humidity_div'),
                              document.getElementById('chart_pressure_div')
                );
            });

            /***************************************************************
             * Fetch samples for the past 7 days and draw the 7-day charts
             */
            $.getJSON('{{ urls.samples_7day_30mavg }}', function(data) {
                // This contains all samples for the day. Included columns are
                // 0: timestamp
                // 1: temperature
                // 2: dewpoint
                // 3: apparenttemp
                // 4: windchill
                // 5: humidity
                // 6: abspressure
                var sampledata = new google.visualization.DataTable(data);

                // Do some formatting
                var temperatureFormatter = new google.visualization.NumberFormat(
                        { pattern: '##.# °C'});
                temperatureFormatter.format(sampledata,1);
                temperatureFormatter.format(sampledata,2);
                temperatureFormatter.format(sampledata,3);
                temperatureFormatter.format(sampledata,4);

                var humidityFormatter = new google.visualization.NumberFormat(
                        { pattern: '##'});
                humidityFormatter.format(sampledata,5);

                var pressureFormatter = new google.visualization.NumberFormat(
                        { pattern: '####.# hPa'});
                pressureFormatter.format(sampledata,6);

                drawAllCharts(sampledata,
                              document.getElementById('chart_7_temperature_tdp_div'),
                              document.getElementById('chart_7_temperature_awc_div'),
                              document.getElementById('chart_7_humidity_div'),
                              document.getElementById('chart_7_pressure_div')
                );
            });

            {% if data.records.total_rainfall > 0 %}
            /***************************************************************
             * Fetch the days hourly rainfall and chart it
             */
            $.getJSON('{{ urls.rainfall }}', function(data) {
                // This contains all samples for the day. Included columns are
                // 0: timestamp
                // 1: temperature
                // 2: dewpoint
                // 3: apparenttemp
                // 4: windchill
                // 5: humidity
                // 6: abspressure
                var rainfall_data = new google.visualization.DataTable(data);

                // Do some formatting
                var rainfallFormatter = new google.visualization.NumberFormat(
                        { pattern: '##.# mm'});
                rainfallFormatter.format(rainfall_data,1);

                var dateFormatter = new google.visualization.DateFormat(
                        { pattern: 'HH'});
                dateFormatter.format(rainfall_data,0);


                var dataView = new google.visualization.DataView(rainfall_data);
                dataView.setColumns([{calc: function(data, row) {
                    return data.getFormattedValue(row, 0); }, type:'string'}, 1]);

                var options = {
                    title: 'Hourly Rainfall (mm)',
                    legend: {position: 'none'},
                    isStacked: true,
                    focusTarget: 'datum'
                };
                var rainfall_chart = new google.visualization.ColumnChart(
                        document.getElementById('chart_hourly_rainfall_div'));
                rainfall_chart.draw(dataView, options);
            });
            {% endif %}
            {% if data.rainfall_7days_total > 0 %}
                /***************************************************************
                 * Fetch the 7 day hourly rainfall and chart it
                 */
                $.getJSON('{{ urls.rainfall_7day }}', function(data) {
                    // This contains all samples for the day. Included columns are
                    // 0: timestamp
                    // 1: temperature
                    // 2: dewpoint
                    // 3: apparenttemp
                    // 4: windchill
                    // 5: humidity
                    // 6: abspressure
                    var rainfall_data = new google.visualization.DataTable(data);

                    // Do some formatting
                    var rainfallFormatter = new google.visualization.NumberFormat(
                            { pattern: '##.# mm'});
                    rainfallFormatter.format(rainfall_data,1);

                    var dateFormatter = new google.visualization.DateFormat(
                            { pattern: 'HH:00 dd-MMM-yyyy'});
                    dateFormatter.format(rainfall_data,0);


                    var dataView = new google.visualization.DataView(rainfall_data);
                    dataView.setColumns([{calc: function(data, row) {
                        return data.getFormattedValue(row, 0); }, type:'string'}, 1]);

                    var options = {
                        title: 'Hourly Rainfall (mm)',
                        legend: {position: 'none'},
                        isStacked: true,
                        focusTarget: 'datum'
                    };
                    var rainfall_chart = new google.visualization.ColumnChart(
                            document.getElementById('chart_7_hourly_rainfall_div'));
                    rainfall_chart.draw(dataView, options);
                });
            {% endif %}

            // Refresh live data every 48 seconds.
            window.setInterval(function(){
                refresh_live_data();
            }, 48000);
        }
    </script>
{% endblock %}